{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<section class="section-{{ section.id }}-padding">
  <product-recommendations
    data-url="{{ routes.product_recommendations_url }}?limit={{ section.settings.products_to_show }}"
    data-section-id="{{ section.id }}"
    data-product-id="{{ product.id }}"
  >
    {% if recommendations.performed and recommendations.products_count > 0 %}
      <h2 class="font-display text-4xl md:text-5xl text-foreground mb-8">
        {{ section.settings.heading | default: 'YOU MIGHT ALSO LIKE' }}
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-{{ section.settings.columns_desktop }} gap-6">
        {% for recommendation in recommendations.products %}
          <div class="text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm group overflow-hidden border-border bg-card hover:border-primary transition-all">
            <div class="relative h-[300px] overflow-hidden">
              {% if recommendation.featured_media %}
                <img
                  alt="{{ recommendation.title | escape }}"
                  loading="lazy"
                  decoding="async"
                  width="400"
                  height="300"
                  class="object-cover group-hover:scale-110 transition-transform duration-500"
                  src="{{ recommendation.featured_media | image_url: width: 400 }}"
                  style="position: absolute; height: 100%; width: 100%; inset: 0px; color: transparent;"
                >
              {% else %}
                <div class="w-full h-full bg-gray-200 flex items-center justify-center">
                  <span class="text-gray-400">No image</span>
                </div>
              {% endif %}

              {% comment %} Product badges {% endcomment %}
              {% if recommendation.compare_at_price > recommendation.price %}
                <span class="inline-flex items-center justify-center rounded-md border w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent [a&]:hover:bg-primary/90 absolute top-4 right-4 bg-red-500 text-white px-3 py-1 text-xs font-bold">
                  SALE
                </span>
              {% elsif recommendation.available == false %}
                <span class="inline-flex items-center justify-center rounded-md border w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent [a&]:hover:bg-primary/90 absolute top-4 right-4 bg-gray-500 text-white px-3 py-1 text-xs font-bold">
                  SOLD OUT
                </span>
              {% else %}
                <span class="inline-flex items-center justify-center rounded-md border w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden border-transparent [a&]:hover:bg-primary/90 absolute top-4 right-4 bg-primary text-primary-foreground px-3 py-1 text-xs font-bold">
                  NEW
                </span>
              {% endif %}
            </div>

            <div class="p-4">
              <h3 class="font-bold text-foreground mb-2">{{ recommendation.title | escape }}</h3>

              {% comment %} Price display {% endcomment %}
              {% if recommendation.compare_at_price > recommendation.price %}
                <div class="mb-3">
                  <span class="text-xl font-bold text-red-500">{{ recommendation.price | money }}</span>
                  <span class="text-sm text-muted-foreground line-through ml-2">
                    {{- recommendation.compare_at_price | money -}}
                  </span>
                </div>
              {% else %}
                <p class="text-xl font-bold text-primary mb-3">{{ recommendation.price | money }}</p>
              {% endif %}

              {% comment %} Quick add button {% endcomment %}
              {% if recommendation.available %}
                <form
                  action="{{ routes.cart_add_url }}"
                  method="post"
                  enctype="multipart/form-data"
                  class="product-card-form"
                >
                  <input type="hidden" name="id" value="{{ recommendation.selected_or_first_available_variant.id }}">
                  <button
                    type="submit"
                    class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive border shadow-xs dark:bg-input/30 dark:border-input dark:hover:bg-input/50 h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 w-full border-primary text-primary hover:bg-primary hover:text-primary-foreground bg-transparent relative overflow-hidden"
                  >
                    <span class="btn-text">QUICK ADD</span>
                    
                    <!-- Loading Spinner -->
                    <div class="loading__spinner hidden">
                      <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                  </button>
                </form>
              {% else %}
                <button
                  disabled
                  class="inline-flex items-center justify-center whitespace-nowrap text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive border shadow-xs dark:bg-input/30 dark:border-input dark:hover:bg-input/50 h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5 w-full bg-gray-200 text-gray-500 cursor-not-allowed"
                >
                  SOLD OUT
                </button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </product-recommendations>
</section>

<script>
class ProductCardForm extends HTMLElement {
  constructor() {
    super();
    this.form = this.querySelector('form');
    this.submitButton = this.querySelector('button[type="submit"]');
    this.btnText = this.querySelector('.btn-text');
    this.loadingSpinner = this.querySelector('.loading__spinner');
    
    if (this.form) {
      this.form.addEventListener('submit', this.onSubmitHandler.bind(this));
    }
  }

  onSubmitHandler(evt) {
    evt.preventDefault();
    
    if (this.submitButton.hasAttribute('disabled')) return;
    
    this.handleAddToCart();
  }

  async handleAddToCart() {
    // Show loading state
    this.setLoadingState(true);
    
    try {
      const formData = new FormData(this.form);
      
      // Add to cart
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        throw new Error('Failed to add to cart');
      }
      
      const result = await response.json();
      
      // Show success state briefly
      this.setSuccessState();
      
      // Trigger cart update event
      document.dispatchEvent(new CustomEvent('cart:updated'));
      
      // Open cart drawer
      setTimeout(() => {
        const cartDrawer = document.querySelector('cart-drawer');
        if (cartDrawer) {
          cartDrawer.open();
        }
        this.setLoadingState(false);
      }, 500);
      
    } catch (error) {
      console.error('Error adding to cart:', error);
      this.setErrorState();
      
      // Reset after error
      setTimeout(() => {
        this.setLoadingState(false);
      }, 2000);
    }
  }

  setLoadingState(loading) {
    if (loading) {
      this.btnText.textContent = 'ADDING...';
      this.loadingSpinner.classList.remove('hidden');
      this.submitButton.disabled = true;
    } else {
      this.btnText.textContent = 'QUICK ADD';
      this.loadingSpinner.classList.add('hidden');
      this.submitButton.disabled = false;
    }
  }

  setSuccessState() {
    this.btnText.textContent = 'ADDED!';
    this.loadingSpinner.classList.add('hidden');
  }

  setErrorState() {
    this.btnText.textContent = 'ERROR';
    this.loadingSpinner.classList.add('hidden');
  }
}

// Register the custom element
if (!customElements.get('product-card-form')) {
  customElements.define('product-card-form', ProductCardForm);
}

// Initialize existing forms
document.addEventListener('DOMContentLoaded', function() {
  const forms = document.querySelectorAll('.product-card-form');
  forms.forEach(form => {
    if (!form.closest('product-card-form')) {
      const wrapper = document.createElement('product-card-form');
      form.parentNode.insertBefore(wrapper, form);
      wrapper.appendChild(form);
    }
  });
});
</script>

{% schema %}
{
  "name": "t:sections.related-products.name",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:sections.related-products.settings.paragraph__1.content"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "default": "t:sections.related-products.settings.paragraph__1.default",
      "label": "t:sections.related-products.settings.heading.label"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        {
          "value": "h2",
          "label": "t:sections.all.heading_size.options__1.label"
        },
        {
          "value": "h1",
          "label": "t:sections.all.heading_size.options__2.label"
        },
        {
          "value": "h0",
          "label": "t:sections.all.heading_size.options__3.label"
        },
        {
          "value": "hxl",
          "label": "t:sections.all.heading_size.options__4.label"
        },
        {
          "value": "hxxl",
          "label": "t:sections.all.heading_size.options__5.label"
        }
      ],
      "default": "h1",
      "label": "t:sections.all.heading_size.label"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4,
      "label": "t:sections.related-products.settings.products_to_show.label"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "t:sections.related-products.settings.columns_desktop.label"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "default": "2",
      "label": "t:sections.related-products.settings.columns_mobile.label",
      "options": [
        {
          "value": "1",
          "label": "t:sections.related-products.settings.columns_mobile.options__1.label"
        },
        {
          "value": "2",
          "label": "t:sections.related-products.settings.columns_mobile.options__2.label"
        }
      ]
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "info": "t:sections.all.colors.has_cards_info",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:sections.related-products.settings.header__2.content"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        {
          "value": "adapt",
          "label": "t:sections.related-products.settings.image_ratio.options__1.label"
        },
        {
          "value": "portrait",
          "label": "t:sections.related-products.settings.image_ratio.options__2.label"
        },
        {
          "value": "square",
          "label": "t:sections.related-products.settings.image_ratio.options__3.label"
        }
      ],
      "default": "adapt",
      "label": "t:sections.related-products.settings.image_ratio.label"
    },
    {
      "type": "select",
      "id": "image_shape",
      "options": [
        {
          "value": "default",
          "label": "t:sections.all.image_shape.options__1.label"
        },
        {
          "value": "arch",
          "label": "t:sections.all.image_shape.options__2.label"
        },
        {
          "value": "blob",
          "label": "t:sections.all.image_shape.options__3.label"
        },
        {
          "value": "chevronleft",
          "label": "t:sections.all.image_shape.options__4.label"
        },
        {
          "value": "chevronright",
          "label": "t:sections.all.image_shape.options__5.label"
        },
        {
          "value": "diamond",
          "label": "t:sections.all.image_shape.options__6.label"
        },
        {
          "value": "parallelogram",
          "label": "t:sections.all.image_shape.options__7.label"
        },
        {
          "value": "round",
          "label": "t:sections.all.image_shape.options__8.label"
        }
      ],
      "default": "default",
      "label": "t:sections.all.image_shape.label"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": false,
      "label": "t:sections.related-products.settings.show_secondary_image.label"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "t:sections.related-products.settings.show_vendor.label"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "t:sections.related-products.settings.show_rating.label",
      "info": "t:sections.related-products.settings.show_rating.info"
    },
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    }
  ]
}
{% endschema %}
